<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<!--<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">-->
<link rel="import" href="../../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../../bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="sentiment-review-view.html">
<link rel="import" href="emotion-review-view.html">

<dom-module id="reddit-analysis-card">
	<style is="custom-style">

		div.card-content{
			text-align: center;
			padding: 20px;
			margin-bottom: 20px;
			min-height: 100px;
		}
		img.platform{
			position: absolute;
			top: 20px;
			left: 15px;
			max-width: 80px;
		}
	    paper-progress {
	      display: block;
	      width: 100%;
	      margin: 20px 0;
	    }

	    paper-progress.blue {
	      --paper-progress-active-color: var(--paper-light-blue-500);
	      --paper-progress-secondary-color: var(--paper-light-blue-100);
	    }

	    #result{
	    	margin-top: 40px;
	    }
	    #loading{
	    	margin-top: 40px;
	    }

	    #error{
		  position: absolute;
		  top: 50%;
		  left: 50%;
		  transform: translate(-50%, -50%);
		  color: #FF5252;
	    }

	    div.analysis-info {
	    	margin-bottom: 50px;
	    }

	    span.grade{
	    	font-size: 150%;
	    }

	    paper-button.red {
	      color: #F44336;
	      --paper-button-flat-focus-color: #FFEBEE;
	    }
	    paper-button.red:hover {
	      background: #FFEBEE;
	    }

	    paper-button.blue {
	      color: var(--paper-light-blue-500);
	      --paper-button-flat-focus-color: var(--paper-light-blue-50);
	    }
	    paper-button.blue:hover {
	      background: var(--paper-light-blue-50);
	    }

	</style>
	<template>
		<paper-material elevation="1">
			<div class="card-content">
				<div id="error" style="display:none;">
					<iron-icon icon="fa:times-circle"></iron-icon> <span>{{error}}</span>
				</div>
				<div id="loading" style="display:none;">
					<span id="progressmessage">{{progressmessage}}</span></br></br>
					<span>{{url}}</span></br></br>
          			<paper-spinner active></paper-spinner>
      				<!--<paper-progress id="loadingprogressbar" value="{{progress}}" max="100" class="blue"></paper-progress>-->
				</div>
				<div id="result" style="display:none;">
					<div class = "analysisInfo">
						<!--<iron-image preload src="{{ image }}" sizing="contain" style="width:256px; height:256px;"></iron-image>-->
						<h3><strong>Search query:</strong></h3> <span>{{ search }}</span>
						<h3><strong>Number of entries:</strong></h3> <span>{{ number_total_articles }}</span>
						<h3><strong>Total Comments:</strong></h3> <span>{{ number_total_comments }}</span>
					</div>
					<div id="emotionsAnalysisInfo" class="analysisInfo">
						<h3><strong>Joy: </strong><i id="happy" class="twa twa-2x twa-smiley"></i><span id="emotionsGradeJoy" class="grade">{{ emotionJoyCounter }}</span></h3>
						<h3><strong>Angry: </strong><i id="angry" class="twa twa-2x twa-angry"></i><span id="emotionsGradeAngry" class="grade">{{ emotionAngryCounter }}</span></h3>
						<h3><strong>Disgusted: </strong><i id="disgusted" class="twa twa-2x twa-unamused"></i><span id="emotionsGradeDisgust" class="grade">{{ emotionDisgustCounter }}</span></h3>
						<h3><strong>Surprised: </strong><i id="surprised" class="twa twa-2x twa-open-mouth"></i><span id="emotionsGradeSurprised" class="grade">{{ emotionSurprisedCounter }}</span></h3>
						<h3><strong>Sad: </strong><i id="sad" class="twa twa-2x twa-cry"></i><span id="emotionsGradeSad" class="grade">{{ emotionSadCounter }}</span></h3>
						<!--<paper-button id="emotions-reviews-button" class="reviews-button" on-tap="showEmotionsReviews" class="blue"><iron-icon icon="fa:commenting-o"></iron-icon> Reviews</paper-button>-->
					</div>
					<br>
					<div id="sentimentsAnalysisInfo" class="analysisInfo">
						<h4><strong>Positive Comments: <span id="sentimentsGradePos" class="grade">{{ positiveComments }}</span></strong></h4>
						<!--<h4><strong>Neutral Comments: <span id="sentimentsGradeNeu" class="grade">{{ neutralComments }}</span></strong></h4>-->
						<h4><strong>Negative Comments: <span id="sentimentsGradeNeg" class="grade">{{ negativeComments }}</span></strong></h4>
						<!--<paper-button id="sentiments-reviews-button" class="reviews-button" on-tap="showSentimentsReviews" class="red"><iron-icon icon="fa:commenting-o"></iron-icon> Reviews</paper-button>-->
					</div>

				</div>
				<img class="platform" src="{{ image_logo }}"></img></div>
			</div>
		</paper-material>
		<iron-ajax
			id="scrapurl"
			url="{{ luigiurl }}"
			handle-as="json"
			on-response="scrapStarted"
			last-response="{{response}}"
			method="POST"
        	header="Content-type:application/json">
        </iron-ajax>
		<iron-ajax
			id="infor"
			url="{{getURL(response)}}"
			handle-as="json"
			on-response="infoReceived"
			method="GET"></iron-ajax>
	</template>
</dom-module>

<script>
	RedditAnalysisCard = Polymer({
		is: 'reddit-analysis-card',

		behaviors: [
  			Polymer.NeonAnimationRunnerBehavior
		],

		properties:{
			error: {
				type: String,
				value: null
			},
			loaded: {
				type: Boolean,
				value: false
			},
			url: String,
			webpage: String,
			analysis_type: String,
			uuid: String,
			image_logo: String,
			image: String,

			search: String,
			number_total_articles: Number,
			number_total_comments: Number,
			articles : Array,
			comments: Array,

			positiveComments: Number,
			neutralComments: Number,
			negativeComments: Number,

			emotionJoyCounter: Number,
			emotionAngryCounter: Number,
			emotionSurprisedCounter: Number,
			emotionSadCounter: Number,
			emotionDisgustCounter: Number,

			grade: String,
			reviews: Array,
			percent: Number,
			progress: String,
			response: Object,
			progressmessage: String,
			averagePolarity: Number,

			luigiurl: {
                type: String,
                value: "http://localhost:8000/startAnalysis"
            },
            elasticsearchurl: {
                type: String,
                value: "http://localhost:9200"
            },

			predominantEmotion: String,

			animationConfig: {
		        type: Object,
		        value: function() {
		          return {
		            'entry': [{
		              name: 'scale-up-animation',
		              node: this,
              		  transformOrigin: '0 0'
		            }],
		            'exit': [{
		              name: 'fade-out-animation',
		              node: this
		            }]
		          }
		        }
	      	}

		},

	    show: function() {
		  this.style.display = 'block';
	      this.playAnimation('entry');
	    },
		factoryImpl: function(url, webpage, analysis_type,luigiurl,elasticsearchurl){
			this.webpage = webpage;
			this.url = url;
			this.analysis_type = analysis_type;
			this.loaded = false;
			this.luigiurl = luigiurl;
            this.elasticsearchurl = elasticsearchurl;
			this.progress = '0';
			this.progressmessage = 'Crawling...';
			this.selectLogo();
			this.$.scrapurl.params={"url":this.url, "analysisType":this.analysis_type, "website":this.webpage};
			this.$.scrapurl.generateRequest();
			this.showLoading(this.progressmessage);
		},
		ready: function(){
			if(this.url == undefined) return;
			if(!this.loaded){
				this.$.scrapurl.params={"url":this.url, "analysisType":this.analysis_type, "website":this.webpage};
				this.$.scrapurl.generateRequest();
				this.showLoading(this.progressmessage);
			}else{
				this.$.error.style.display='none';
				this.$.loading.style.display='none';
				this.$.result.style.display='block';
			}
			this.selectLogo();
		},
		scrapStarted: function(event){				
			response = event.detail.response;
			if(response == null){
				this.showError('Connection error. Please check your internet connection.');
				this.showErrorToast('An error ocurred while analyzing: Connection error. Please check your internet connection.');
				return;
			}
			console.log(response);
			this.error = response.error;
			if(this.error == null){
				this.uuid = response.id;
				this.loaded = !response.loading;
				this.progress = response.progress;
				this.progressmessage = 'Processing...';
				this.retrieveInfoDelayed(1000);
				this.showLoading(this.progressmessage);
			}else{
				this.loaded = true;
				this.showError(this.error);
				this.showErrorToast('An error occurred while analyzing: ' + this.error);
			}
		},
		getURL: function(response){
			if(response == null){
				this.showError('Connection error. Please check your Luigi endpoint.');
				this.showErrorToast('An error ocurred while analyzing: Connection error. Please check your Luigi endpoint.');
				return;
			}
			else return this.elasticsearchurl+ '/' +response['index']+'/_search?q=createdAt:'+response['id'] + "&size=5000"
		},
		retrieveInfoDelayed: function(delay){
			this.async(function(){
				//this.$.infor.params = {"id":this.id,"analysis_type":this.analysisType,"website":this.website};
				this.$.infor.generateRequest();	
			}, delay);
		},
		infoReceived: function(event){
			elasticresponse = event.detail.response;
			try{
				response = elasticresponse.hits.hits;
				console.log(response.length);
				this.number_total_articles=0;
				this.number_total_comments=0;
				//Get posts and comments
				for(i = 0; i < response.length; i++){
					doc_type = response[i]['_type'];				
					//console.log(doc_type);
					if(doc_type === 'articles'){
						//Articles
						this.number_total_articles += 1;						
					} 

					if(doc_type === 'comments'){
						//Comments
						this.number_total_comments += 1;
					}
				}
			}catch(err){
				console.log(err);
				this.showError('Crawling error.. Please try again later.');
				this.showErrorToast('An error ocurred while analyzing: Crawling error. Please try again later.');
				return;
			}
			if(response == null){
				this.showError('Connection error. Please check your internet connection.');
				this.showErrorToast('An error ocurred while analyzing: Connection error. Please check your internet connection.');
				return;
			}
			this.loaded = !response.loading;
			this.error = response.error;
			this.progress = response.progress;
			if(this.error != null){
				this.showError(this.error);
				this.showErrorToast('An error occurred while analyzing: ' + this.error);
			}else if(!this.loaded){
				this.retrieveInfoDelayed(2000);
				if(!response.scraping){
					this.progressmessage = 'Analyzing...';
					this.showLoading(this.progressmessage);
				}
			}else{
				console.log(response)
				this.search = this.url


				if(this.analysis_type == 'sentiments'){
					this.positiveComments = 0;
					this.neutralComments = 0;
					this.negativeComments = 0;

					for(i=0; i< response.length; i++){
						console.log(response[i]['_source'].polarity);
						if(response[i]['_type'] === 'comments'){
							if(response[i]['_source'].polarity === "1"){
								this.positiveComments += 1;
							}
							if(response[i]['_source'].polarity === "0"){
								this.neutralComments += 1;
							}
							if(response[i]['_source'].polarity === "-1"){
								this.negativeComments += 1;
							}
						}						
					}
					/*this.positiveComments = this.positiveComments *100/this.number_total_comments;
					this.neutralComments = this.neutralComments *100/this.number_total_comments;
					this.negativeComments = this.negativeComments *100/this.number_total_comments;*/
					

					this.applyColorBySentimentGrade();
				}else{
					this.$.sentimentsAnalysisInfo.style="display:none;";
				}

				if(this.analysis_type == 'emotions'){
					this.emotionJoyCounter = 0;
					this.emotionAngryCounter = 0;
					this.emotionSurprisedCounter = 0;
					this.emotionDisgustCounter = 0;
					this.emotionSadCounter = 0;
					for(i=0; i< response.length; i++){
						console.log(response[i]['_source'].polarity);
						if(response[i]['_type'] === 'comments'){
							var emotion = response[i]['_source'].emotion;
							if(emotion === 'joy'){
								this.emotionJoyCounter += 1;
							}
							if(emotion === 'anger'){
								this.emotionAngryCounter += 1;
							}
							if(emotion === 'sadness'){
								this.emotionSadCounter += 1;
							}
							if(emotion === 'neutral-emotion'){
								this.emotionSurprisedCounter += 1;
							}
							if(emotion === 'disgust'){
								this.emotionDisgustCounter += 1;
							}
						}						
					}
					
					this.applyColorByEmotionGrade();
				}else{
					this.$.emotionsAnalysisInfo.style="display:none;";
				}

				this.showResult();
				//this.showOkToast(this.search +' analysis finished!');
			}
		},
		applyColorBySentimentGrade: function(){
			this.$.sentimentsGradePos.style.color= '#00E676';
			this.$.sentimentsGradeNeu.style.color= '#AAAAAA';
			this.$.sentimentsGradeNeg.style.color = '#FF1744';
		},
		applyColorByEmotionGrade: function(){
				this.$.emotionsGradeAngry.style.color= '#C81F1D';
				
				this.$.emotionsGradeDisgust.style.color= '#E0901B';
				
				this.$.emotionsGradeSurprised.style.color= '#F7EA2A';
				
				this.$.emotionsGradeJoy.style.color= '#75B84C';
				
				this.$.emotionsGradeSad.style.color= '#395EAD';	
		},
		showLoading: function(message){
			this.$.result.style.display='none';
			this.$.error.style.display='none';
			this.$.loading.style.display='block';
			//this.$.loadingprogressbar.value=this.progress;
			this.$.progressmessage.innerHTML = message;			
		},
		showResult: function(){
			this.$.error.style.display='none';
			this.$.loading.style.display='none';
			this.$.result.style.display='block';
		},
		showError: function(message){
			this.error = message;
			this.$.loading.style.display='none';
			this.$.result.style.display='none';
			this.$.error.style.display='block';
		},
		selectLogo: function(){
	      if(this.webpage == "yelp")
	        this.image_logo = "/images/yelp_logo.png";
	      else if(this.webpage == "amazon")
	        this.image_logo = "/images/amazon_logo.png";
	      else if(this.webpage == "facebook")
	        this.image_logo = "/images/facebook_logo.png";
	      else if(this.webpage == "youtube")
	        this.image_logo = "/images/youtube_logo.png";
	      else if(this.webpage == "tripadvisor")
	        this.image_logo = "/images/tripadvisor_logo.png";
	      else if(this.webpage == "foursquare")
	        this.image_logo = "/images/foursquare_logo.png";
	      else if(this.webpage == "twitter")
	        this.image_logo = "/images/twitter_logo.png";
	      else if(this.webpage == "reddit")
	        this.image_logo = "/images/reddit_logo.png";
		},
	    showOkToast: function(message){
	      this.showToast(message, '#00E676');
	    },
	    showErrorToast: function(message) {
	      this.showToast(message, '#F44336');
	    },
	    showToast: function(message, color) {
	        toast = document.getElementById('toast');
	        toast.style.zIndex = 10000;
	        toast.style.background = color;
	        toast.text = message;
	        toast.show();
	    },
	    showSentimentsReviews: function() {
	    	this.showSentimentsDialog('Reviews', this.reviews);
	    },
	    showSentimentsDialog: function(title, reviews){
	    	document.getElementById('scrollable-dialog-title').innerHTML=title;
	    	var scrollableContent = document.getElementById('scrollable-content');
	    	scrollableContent.innerHTML = "";
	    	for(i=0; i<reviews.length; i++){
	    		var review_object = reviews[i];
	    		var review = new SentimentReviewView(review_object);
	    		scrollableContent.appendChild(review);
	    		var hr = document.createElement('hr');
	    		scrollableContent.appendChild(hr);
	    	}
	    	document.getElementById('scrollable-dialog').open();
	    },
	    showEmotionsReviews: function() {
	    	this.showEmotionsDialog('Reviews', this.reviews);
	    },
	    showEmotionsDialog: function(title, reviews){
	    	document.getElementById('scrollable-dialog-title').innerHTML=title;
	    	var scrollableContent = document.getElementById('scrollable-content');
	    	scrollableContent.innerHTML = "";
	    	for(i=0; i<reviews.length; i++){
	    		var review_object = reviews[i];
	    		var review = new EmotionReviewView(review_object);
	    		scrollableContent.appendChild(review);
	    		var hr = document.createElement('hr');
	    		scrollableContent.appendChild(hr);
	    	}
	    	document.getElementById('scrollable-dialog').open();
	    }
	});
</script>
